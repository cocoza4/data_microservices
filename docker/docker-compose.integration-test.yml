version: "3.9"
services:

  mongodb-test:
    image: mongo:7.0.3
    restart: always
    ports:
      - 27017:27017
    environment:
      - MONGO_INITDB_ROOT_USERNAME:mongouser
      - MONGO_INITDB_ROOT_PASSWORD:mongopass

  app-test:
    image: data_microservices-test:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - 8080:8080
    environment:
      - MONGO_URI=mongodb://mongodb-test:27017
      - MONGO_DBNAME=productdb_test
      - SECRET_USER=testuser
      - SECRET_PASSWORD=testpassword
      - SECRET_KEY=testkey
    depends_on:
      - mongodb-test

  test:
    image: integration-test:latest
    build:
      context: ../
      dockerfile: docker/Dockerfile.test
    environment:
      - MONGO_URI=mongodb://mongodb-test:27017
      - MONGO_DBNAME=productdb_test
      - SECRET_USER=testuser
      - SECRET_PASSWORD=testpassword
      - SECRET_KEY=testkey
    depends_on:
      - app-test
    command: "go test"
